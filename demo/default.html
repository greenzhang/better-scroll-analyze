<html>

<head>
  <meta charset="utf-8" />
  <title>scroll</title>
  <style type="text/css">
    body {
      overflow-y: hidden;
    }

    .content {
      width: 100%;
      will-change: transform;
    }

    .scroll-head {
      width: 100%;
      margin-top: -240px;
      height: 240px;
    }

    .container {
      transform: translateZ(0);
    }

    ul {
      height: 50px;
    }
  </style>
</head>

<body>
  <div class="content">
    <div class="container scroll-head"></div>
    <div class="scroll-container" style="height:100%;overflow:auto;">
      <ul>1</ul>
      <ul>2</ul>
      <ul>3</ul>
      <ul>4</ul>
      <ul>5</ul>
      <ul>6</ul>
      <ul>7</ul>
      <ul>8</ul>
      <ul>9</ul>
      <ul>10</ul>
      <ul>11</ul>
      <ul>12</ul>
      <ul>13</ul>
      <ul>14</ul>
      <ul>15</ul>
      <ul>16</ul>
      <ul>17</ul>
      <ul>18</ul>
      <ul>19</ul>
      <ul>20</ul>
      <ul>21</ul>
      <ul>22</ul>
      <ul>23</ul>
      <ul>24</ul>
      <ul>25</ul>
      <ul>26</ul>
      <ul>27</ul>
      <ul>28</ul>
      <ul>29</ul>
      <ul>30</ul>
      <ul>31</ul>
      <ul>32</ul>
      <ul>33</ul>
      <ul>34</ul>
      <ul>35</ul>
      <ul>36</ul>
      <ul>37</ul>
      <ul>38</ul>
      <ul>39</ul>
      <ul>40</ul>
      <ul>41</ul>
      <ul>42</ul>
      <ul>43</ul>
      <ul>44</ul>
      <ul>45</ul>
      <ul>46</ul>
      <ul>47</ul>
      <ul>48</ul>
      <ul>49</ul>
      <ul>50</ul>
    </div>
  </div>

  <!-- <div align="center">
    <nav class="container">
      <ul>1</ul>
      <ul>2</ul>
      <ul>3</ul>
      <ul>4</ul>
      <ul>5</ul>
      <ul>6</ul>
      <ul>7</ul>
      <ul>8</ul>
      <ul>9</ul>
      <ul>10</ul>
      <ul>11</ul>
      <ul>12</ul>
      <ul>13</ul>
      <ul>14</ul>
      <ul>15</ul>
      <ul>16</ul>
      <ul>17</ul>
      <ul>18</ul>
      <ul>19</ul>
      <ul>20</ul>
      <ul>21</ul>
      <ul>22</ul>
      <ul>23</ul>
      <ul>24</ul>
      <ul>25</ul>
      <ul>26</ul>
      <ul>27</ul>
      <ul>28</ul>
      <ul>29</ul>
      <ul>30</ul>
      <ul>31</ul>
      <ul>32</ul>
      <ul>33</ul>
      <ul>34</ul>
      <ul>35</ul>
      <ul>36</ul>
      <ul>37</ul>
      <ul>38</ul>
      <ul>39</ul>
      <ul>40</ul>
      <ul>41</ul>
      <ul>42</ul>
      <ul>43</ul>
      <ul>44</ul>
      <ul>45</ul>
      <ul>46</ul>
      <ul>47</ul>
      <ul>48</ul>
      <ul>49</ul>
      <ul>50</ul>
    </nav>
  </div> -->
  <script>
    const content = document.querySelector('.content')
    const container = document.querySelector('.scroll-container')

    function throttle(func, wait, options) {
      var timeout, context, args, result
      var previous = 0
      if (!options) options = {}

      var later = function () {
        previous = options.leading === false ? 0 : Date.now()
        timeout = null
        result = func.apply(context, args)
        if (!timeout) context = args = null
      }

      var throttled = function () {
        var now = Date.now()
        if (!previous && options.leading === false) previous = now
        var remaining = wait - (now - previous)
        context = this
        args = arguments
        if (remaining <= 0 || remaining > wait) {
          if (timeout) {
            clearTimeout(timeout)
            timeout = null
          }
          previous = now
          result = func.apply(context, args)
          if (!timeout) context = args = null
        } else if (!timeout && options.trailing !== false) {
          timeout = setTimeout(later, remaining)
        }
        return result
      }

      throttled.cancel = function () {
        clearTimeout(timeout)
        previous = 0
        timeout = context = args = null
      }

      return throttled
    }
    // const scrollH = document.querySelector('.scroll-head')
    // const height = 240
    // function scrollHead(pes) {

    //   scrollH.style.transform = `translateY(${height * pes * 0.8}px)`
    //   container.style.transform = `translateY(${height * pes}px)`
    // }
    // function resetScrollHead() {
    //   scrollH.style.transform = 'none'
    //   container.style.transform = 'none'
    // }


    // class Scroller {
    //   constructor(_container) {
    //     this.container = _container
    //     this.isGlobal = _container === window
    //     // 滚动中
    //     this.pulling = false

    //     // 刷新中
    //     this.refreshing = false

    //     // touch状态
    //     this.isInTouchStatus = false

    //     // start page X
    //     this.startPageX = 0
    //     // pre page X
    //     this.prePageX = 0
    //     // start page Y
    //     this.startPageY = 0
    //     // pre page Y
    //     this.prePageY = 0

    //     this.threshold = 300

    //     this.distance = 0
    //     // moving direction
    //     this.movingDirection = 'none'
    //     this.attachTouchEvents()
    //   }
    //   attachTouchEvents() {
    //     this.container.addEventListener('touchstart', throttle(this.touchStart.bind(this), 10), { passive: false })
    //     this.container.addEventListener('touchmove', throttle(this.touchMove.bind(this), 10), { passive: false })
    //     this.container.addEventListener('touchend', throttle(this.touchEnd.bind(this), 10), { passive: false })
    //   }
    //   touchStart(event) {
    //     // 刷新中 无操作
    //     if (this.refreshing) {
    //       return
    //     }
    //     if (!event instanceof Event) {
    //       return
    //     }

    //     // 否则开启touch状态
    //     this.isInTouchStatus = true
    //     let { touches } = event
    //     this.startPageY = this.prePageY = touches[0].pageY
    //   }
    //   touchMove(event) {
    //     // 如果不在
    //     if (!this.isInTouchStatus) {
    //       return
    //     }

    //     this.pulling = true

    //     let { touches } = event
    //     if (!touches[0]) {
    //       return
    //     }

    //     const pageY = touches[0].pageY
    //     const distanceY = pageY - this.prePageY
    //     if (distanceY < 0) {
    //       this.movingDirection = 'up'
    //     } else if (distanceY > 0) {
    //       this.movingDirection = 'down'
    //     }
    //     this.calcPullDistance(distanceY)
    //     switch (this.movingDirection) {
    //       case 'up':
    //         return this.checkPullUp()
    //       case 'down':
    //         return this.checkPullDown()
    //       default:
    //         break
    //     }
    //   }
    //   checkPullDown() {
    //     if (this.isTop()) {
    //       if (this.distance < this.threshold) {
    //         console.log('还没到位了');
    //         console.log(this.distance / this.threshold);
    //         scrollHead(this.distance / this.threshold)
    //       } else {
    //         console.log('到位了');
    //         this.refreshing = true
    //         // this.prePageY = pageY
    //       }
    //     }
    //   }
    //   checkPullUp() {

    //   }
    //   calcPullDistance(distance) {
    //     this.distance = distance / 3
    //   }
    //   isTop() {
    //     return this.isGlobal ? this.container.pageYOffset <= 0 : this.container.scrollTop <= 1
    //   }
    //   touchEnd() {
    //     console.log('touch end')
    //     resetScrollHead()
    //     this.refreshing = false
    //     this.pulling = false
    //     this.isInTouchStatus = false
    //   }
    // }
    const noop = () => {

    }
    const assign = (source, target) => {
      if (target == void (0)) {
        throw new TypeError('[scroller]:Target should be an object.')
      }
      const tempTarget = Object(target)
      for (const key in tempTarget) {
        if (key in source) {
          source[key] = tempTarget[key]
        }
      }
      return source
    }
    const addEvent = (el, type, fn, capture) => {
      el.addEventListener(type, fn, { passive: false, capture: !!capture })
    }
    const defaultOptions = {
      threshold: 0.3,
      moveCount: 200,
      percentage: 0,
      container: null,
      touchStartFn: noop,
      touchMoveFn: noop,
      touchEndFn: noop,
      watchRefresh: noop
    }
    class Scroller {
      constructor(options) {
        this.options = assign(defaultOptions, options)
        this.container = this.options.container
        this.scrollers = []
        if (!options.container instanceof HTMLElement) {
          throw new Error('[scroller]:Container should be a html element!')
        }
        this.isGlobal = this.options.container === window

        this.isInTouchStatus = false

        this.refreshFlag = false

        this.isThreshold = false
        this.movingDirection = 'none'
        this.startPageY = 0
        this.prePageY = 0
        this.attachEvent()
        this.watchRefreshFlag()
      }
      addScroller(path, name, top = 0, left = 0) {
        this.removeScroller(path, name)
        this.scrollers.push({ path, name, top, left })
      }
      findScroller(path, name) {
        const findeds = this.scrollers.filter(item => {
          return item.path === path && item.name === name
        })
        return findeds.length > 0 ? findeds[0] : null
      }
      removeScroller(path, name) {
        const finded = this.findScroller(path, name)

        // If finded, remove its old value
        if (finded) {
          this.scrollers.splice(this.scrollers.indexOf(finded), 1)
        }
      }
      getScroller(path, name, top = 0, left = 0) {
        const finded = this.findScroller(path, name)

        if (finded) {
          if (finded.top) top = finded.top
          if (finded.left) left = finded.left
        }

        return { top, left }
      }
      isTop() {
        return this.isGlobal ? this.container.pageYOffset <= 0 : this.container.scrollTop <= 1
      }
      watchRefreshFlag() {
        let self = this
        if (typeof Object.defineProperty !== 'function') {
          return
        }
        let refreshFlag = false
        Object.defineProperty(this, 'refreshFlag', {
          get() {
            return refreshFlag
          },
          set(newVal) {
            refreshFlag = newVal
            if(refreshFlag) {
              self.options.watchRefresh()
            }
          }
        })
      }
      attachEvent() {
        const target = this.options.container
        addEvent(target, 'touchstart', this)
        addEvent(target, 'touchmove', this)
        addEvent(target, 'touchend', this)
      }
      handleEvent(event) {
        if (!event instanceof Event) return
        switch (event.type) {
          case 'touchstart':
          case 'mousedown':
            return this.touchStart(event)
          case 'touchmove':
            return this.touchMove(event)
          case 'touchend':
            return this.touchEnd(event)
          default:
            break;
        }
      }
      touchStart(event) {
        if (this.refreshFlag) {
          event.preventDefault()
          return
        }
        const { touches } = event
        this.startPageY = this.prePageY = touches[0].pageY
        this.isInTouchStatus = true
      }
      touchMove(event) {
        if (!this.isInTouchStatus || this.refreshFlag) return
        const { touches } = event
        const pageY = touches[0].pageY
        this.percentage = (this.startPageY - pageY) / window.screen.height / 3
        const distanceY = pageY - this.prePageY
        if (distanceY < 0) {
          this.movingDirection = 'up'
        } else if (distanceY > 0) {
          this.movingDirection = 'down'
        }

        if (this.isTop() && this.movingDirection === 'down') {
          if (this.percentage < 0) {
            event.preventDefault()
          }
          this.isThreshold = Math.abs(this.percentage) > this.options.threshold
          if (this.isThreshold) {
            this.refreshFlag = true
          }
          this.options.touchMoveFn(Math.min(Math.abs(this.percentage) / this.options.threshold, 1))
        }
      }
      touchEnd(event) {
        this.isInTouchStatus = false
        this.options.touchEndFn(Math.min(Math.abs(this.percentage) / this.options.threshold, 1))
      }
      setRefreshingStatus(status) {
        this.refreshFlag = status
      }
    }
    const touchMoveFn = (per) => {
      content.style.transform = 'translate3d(0,' + 240 * per + 'px,0)'
    }
    const touchEndFn = (per) => {
      if (per < 1) {
        content.style.transform = 'none'
      } else {
        ss.setRefreshingStatus(false);
        setTimeout(() => {
          content.style.transform = 'none'
        }, 1000);
      }
    }
    const watchRefresh = () => {
      console.log('watchRefresh')
    }
    const options = {
      threshold: 0.3,
      moveCount: 200,
      percentage: 0,
      container: container,
      touchMoveFn: touchMoveFn,
      touchEndFn: touchEndFn,
      watchRefresh: watchRefresh
    }


    const ss = new Scroller(options)
  </script>
</body>

</html>
